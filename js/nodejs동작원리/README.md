# nodejsì˜ ë‚´ë¶€ ë™ì‘ ì›ë¦¬

í‚¤ì›Œë“œ

> libuv, ì´ë²¤íŠ¸ë£¨í”„, ì›Œì»¤ì“°ë ˆë“œ, ë¹„ë™ê¸°, ì´ë²¤íŠ¸ ê¸°ë°˜, ë…¼ë¸”ë¡œí‚¹,ì‹±ê¸€ ìŠ¤ë ˆë“œ, event Emitter

ğŸ“Œ ëª©ì°¨

1. [NodeJs êµ¬ì„±](#nodejs-êµ¬ì„±)
2. [ì´ë²¤íŠ¸ ë£¨í”„ë€?](#ì´ë²¤íŠ¸-ë£¨í”„ë€?)
3. [NodeJsì˜ ë¹„ë™ê¸° ì²˜ë¦¬](#nodejsì˜-ë¹„ë™ê¸°-ì²˜ë¦¬)
4. [Event Emitter](#event-emitter)

# nodejs êµ¬ì„±

Node.jsë¥¼ í¬ê²Œ ë‚˜ëˆ ë´¤ì„ ë•Œ, `ë‚´ì¥ ë¼ì´ë¸ŒëŸ¬ë¦¬`ì™€ `v8ì—”ì§„` ê·¸ë¦¬ê³  `libuv`ë¡œ êµ¬ì„±ë˜ì–´ ìˆë‹¤. Node.jsì˜ íŠ¹ì„±ì¸ ì´ë²¤íŠ¸ ê¸°ë°˜, ë…¼ë¸”ë¡œí‚¹ I/O ëª¨ë¸ë“¤ì€ ëª¨ë‘ libuv ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ êµ¬í˜„ëœë‹¤.

# libuv

- node.jsì—ì„œ ì‚¬ìš©í•˜ëŠ” `ë¹„ë™ê¸° I/Oë¼ì´ë¸ŒëŸ¬ë¦¬`
- node.jsì˜ íŠ¹ì„±ì¸ ì´ë²¤íŠ¸ ê¸°ë°˜, `ë…¼ ë¸”ë¡œí‚¹ I/O ëª¨ë¸`ì€ ëª¨ë‘ libuvì—ì„œ êµ¬í˜„ë¨.
- ì½œë°± í•¨ìˆ˜ë“¤ì€ libuv ë‚´ì— ìœ„ì¹˜í•œ `ì´ë²¤íŠ¸ ë£¨í”„`ì—ì„œ ê´€ë¦¬ ë° ì²˜ë¦¬ëœë‹¤.

### ì´ë²¤íŠ¸ ê¸°ë°˜

- node.jsëŠ” ì½œ ìŠ¤íƒ, ì´ë²¤íŠ¸ íì— í•­ìƒ ëª…ë ¹ì„ ëŒ€ê¸°ì‹œí‚¤ì§€ ì•Šê³  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆevent listenerë¥¼ í†µí•´` ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ì½œë°±í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ì‹`ì„ ì‚¬ìš©í•œë‹¤.
- ì˜ˆë¥¼ ë“¤ì–´ ì„œë²„ì— ì ‘ì†í•˜ëŠ” ì´ë²¤íŠ¸eventë¥¼ ë“£ëŠ”listen ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆevent listenerë¥¼ ì½”ë”©í•˜ê³  í•´ë‹¹ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ì½œë°±í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•œë‹¤. (í”íˆ ì‚¬ìš©í•˜ê³  ìˆëŠ”` routerë„ ì´ë²¤íŠ¸ ê¸°ë°˜`ìœ¼ë¡œ ë™ì‘)

### ë…¼ ë¸”ë¡œí‚¹ I/O

- Node.jsëŠ” ì‹±ê¸€ìŠ¤ë ˆë“œ ë…¼ë¸”ë¡œí‚¹ ëª¨ë¸ë¡œ êµ¬ì„±ë˜ì–´ ìˆë‹¤. í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë¡œ ë™ì‘í•˜ì§€ë§Œ, ë¹„ë™ê¸° I/O ì‘ì—…ì„ í†µí•´ ìš”ì²­ë“¤ì„ ì„œë¡œ ë¸”ë¡œí‚¹í•˜ì§€ ì•Šë‹¤. ì¦‰, ë™ì‹œì— ë§ì€ ìš”ì²­ë“¤ì„ ë¹„ë™ê¸°ë¡œ ìˆ˜í–‰í•¨ìœ¼ë¡œì¨ ì‹±ê¸€ìŠ¤ë ˆë“œì¼ì§€ë¼ë„ ë…¼ë¸”ë¡œí‚¹ì´ ê°€ëŠ¥í•˜ë‹¤.

### libuv ë™ì‘ ë°©ì‹

- node.jsëŠ” libuv ìœ„ì—ì„œ ë™ì‘í•˜ì—¬ node ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë  ë•Œ libuvì—ëŠ” ìŠ¤ë ˆë“œ í’€(4ê°œê°€ ê¸°ë³¸)ì´ ìƒì„±ëœë‹¤.
- libuv

# ì´ë²¤íŠ¸ ë£¨í”„ë€?

- `ì´ë²¤íŠ¸ì— ë”°ë¼ í˜¸ì¶œë˜ëŠ” ì½œë°±í•¨ìˆ˜ë¥¼ ê´€ë¦¬`í•˜ëŠ” ê²ƒì´ ë°”ë¡œ ì´ë²¤íŠ¸ ë£¨í”„
- ì´ë²¤íŠ¸ ë£¨í”„ëŠ” ì—¬ëŸ¬ ê°œì˜ `í˜ì´ì¦ˆ(Phase)`ë“¤ì„ ê°–ê³  ìˆìœ¼ë©° ê° phase ë“¤ì€ `FIFO í`ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©°, ì´ íì—ëŠ” íŠ¹ì • ì´ë²¤íŠ¸ì˜ ì½œë°±ë“¤ì„ ë„£ê³ , CPUê°€ í• ë‹¹(=ì´ë²¤íŠ¸ë£¨í”„ê°€ í•´ë‹¹ phaseë¥¼ í˜¸ì¶œí• ë•Œ)ë  ë•Œ ì‹¤í–‰
- ì´ë²¤íŠ¸ ë£¨í”„ëŠ” `ë¼ìš´ë“œ ë¡œë¹ˆ(round-robin)` ë°©ì‹ìœ¼ë¡œ ë…¸ë“œ í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œë ë•Œê¹Œì§€ ì¼ì • ê·œì¹™ì— ë”°ë¼ `ì—¬ëŸ¬ê°œì˜ í˜ì´ì¦ˆë“¤ì„ ê³„ì† ìˆœíšŒ`
- ê³µì‹ë¬¸ì„œ
  > Event loopëŠ” javascriptê°€ ë‹¨ì¼ ìŠ¤ë ˆë“œì„ì—ë„ ê°€ëŠ¥í•  ë•Œë§ˆë‹¤ ì‹œìŠ¤í…œ ì»¤ë„ì— ì‘ì—…ì„ ì˜¤í”„ë¡œë“œí•˜ì—¬ node.jsê°€ ë¹„ì°¨ë‹¨I/Oì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤. ëŒ€ë¶€ë¶„ì˜ ìµœì‹  ì»¤ë„ì€ ë‹¤ì¤‘ ìŠ¤ë ˆë“œì´ë¯€ë¡œ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” ì—¬ëŸ¬ ì‘ì—…ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤. ì´ëŸ¬í•œ ì‘ì—… ì¤‘ í•˜ë‚˜ê°€ ì™„ë£Œë˜ë©´ ì»¤ë„ì€ node.jsì— ì•Œë ¤ ì ì ˆí•œ ì½œë°±ì„ `í´`íì— ì¶”ê°€í•˜ì—¬ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í•¨.
- ë¡œë¹ˆ í”„ë¡œì„¸ìŠ¤ ìŠ¤ì¼€ì¤„ë§:
  > ê·¸ë£¹ ë‚´ì— ìˆëŠ” ëª¨ë“  ìš”ì†Œë“¤ì„ í•©ë¦¬ì ì¸ ìˆœì„œì— ì…ê°í•˜ì—¬ ë½‘ëŠ” ë°©ë²•ìœ¼ë¡œì„œ, ëŒ€ê°œ ë¦¬ìŠ¤íŠ¸ì˜ ë§¨ ìœ„ì—ì„œ ì•„ë˜ë¡œ ê°€ë©° í•˜ë‚˜ ì”© ë½‘ê³ , ëë‚˜ë©´ ë‹¤ì‹œ ë§¨ ìœ„ë¡œ ëŒì•„ê°€ëŠ” ì‹ìœ¼ë¡œ ì§„í–‰ëœë‹¤. ì‰½ê²Œ ë§í•´ ë¼ìš´ë“œ ë¡œë¹ˆì€ â€œê¸°íšŒë¥¼ ì°¨ë¡€ëŒ€ë¡œ ë°›ê¸°â€ë¼ê³  ì´í•´í•´ë„ ì¢‹ì„ ê²ƒì´ë‹¤. ì»´í“¨í„° ìš´ì˜ì—ì„œ, ì»´í“¨í„° ìì›ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¸°íšŒë¥¼ í”„ë¡œê·¸ë¨ í”„ë¡œì„¸ìŠ¤ë“¤ì—ê²Œ ê³µì •í•˜ê²Œ ë¶€ì—¬í•˜ê¸° ìœ„í•œ í•œ ë°©ë²•ìœ¼ë¡œì„œ, ê° í”„ë¡œì„¸ìŠ¤ì— ì¼ì •ì‹œê°„ì„ í• ë‹¹í•˜ê³ , í• ë‹¹ëœ ì‹œê°„ì´ ì§€ë‚˜ë©´ ê·¸ í”„ë¡œì„¸ìŠ¤ëŠ” ì ì‹œ ë³´ë¥˜í•œ ë’¤ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ì—ê²Œ ê¸°íšŒë¥¼ ì£¼ê³ , ë˜ ê·¸ ë‹¤ìŒ í”„ë¡œì„¸ìŠ¤ì—ê²Œ í•˜ëŠ” ì‹ìœ¼ë¡œ, ëŒì•„ê°€ë©° ê¸°íšŒë¥¼ ë¶€ì—¬í•˜ëŠ” ìš´ì˜ë°©ì‹ì´ ìˆëŠ”ë°, ì´ë¥¼ í”íˆ ë¼ìš´ë“œ ë¡œë¹ˆ í”„ë¡œì„¸ìŠ¤ ìŠ¤ì¼€ì¤„ë§ì´ë¼ê³  ë¶€ë¥¸ë‹¤.

## ì´ë²¤íŠ¸ ë£¨í”„ì˜ phaseë“¤ ì„¤ëª…

```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€>â”‚ timers â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”‚ pending callbacks â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”‚ idle, prepare â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ incoming: â”‚
â”‚ â”‚ poll â”‚<â”€â”€â”€â”€â”€â”¤ connections, â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ data, etc. â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”‚ check â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”¤ close callbacks â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### `timers`

- setTimeout, setIntervalì— ì˜í•´ ì˜ˆì•½ëœ ì½œë°± ì‹¤í–‰
- íƒ€ì´ë¨¸ ì½œë°±ì€ ì§€ì •ëœ ì‹œê°„ì´ ê²½ê³¼í•œ í›„ ì˜ˆì•½í•  ìˆ˜ ìˆëŠ” í•œ ë¹¨ë¦¬ ì‹¤í–‰
- ë‚´ë¶€ë¡œì§ì€ pollíì— ë¨¼ì € ë“±ë¡ëœ ì½œë°±ë“¤ì´ ì²˜ë¦¬ë˜ê³  ì‹¤í–‰ë¨.
- ê¸°ìˆ ì ìœ¼ë¡œ í´ ë‹¨ê³„ ëŠ” íƒ€ì´ë¨¸ê°€ ì‹¤í–‰ë˜ëŠ” ì‹œê¸°ë¥¼ ì œì–´

### `pending callbacks`(I/O callbacks)

- ë‹¤ìŒ ë£¨í”„ ë°˜ë³µìœ¼ë¡œ ì—°ê¸°ëœ(pending) I/O ì½œë°± ì‹¤í–‰, í´ë¡œì¦ˆ ì½œë°±, íƒ€ì´ë¨¸ë¡œ ìŠ¤ì¼€ì¤„ë§ëœ ì½œë°±, setImmediate()ë¥¼ ì œì™¸í•œ ê±°ì˜ ëª¨ë“  ì½œë°±ë“¤ì„ ì§‘í–‰
- http, api, db ë“±ë“±

### `idle, prepare`

- ë‚´ë¶€ì ìœ¼ë¡œë§Œ ì‚¬ìš©

### `poll`

- ìƒˆ I/Oì´ë²¤íŠ¸ ê²€ìƒ‰. i/Oê´€ë ¨ ì½œë°±(í´ë¡œì¦ˆ ì½œë°±, íƒ€ì´ë¨¸ë¡œ ìŠ¤ì¼€ì¤„ë§ëœ ì½œë°±,setImmediate()ë¥¼ ì œì™¸í•œ ê±°ì˜ ëª¨ë“  ì½œë°±) ì‹¤í–‰.
- I/Oë¥¼ ì°¨ë‹¨í•˜ê³  í´ë§í•´ì•¼ í•˜ëŠ” ì‹œê°„ì„ ê³„ì‚°í•œ ë‹¤ìŒ -> í´ í ì—ì„œ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬
- poll íì— ìŒ“ì¸ ì½œë°±í•¨ìˆ˜ë“¤ì„ í•œë„ê°€ ë„˜ì§€ ì•Šì„ë•Œê¹Œì§€ ëª¨ë‘ ë™ê¸°ì ìœ¼ë¡œ ì‹¤í–‰
- ë§Œì•½ í•œë„ê°€ ë„˜ê±°ë‚˜, ë”ì´ìƒ ì‹¤í–‰í•  ì½œë°±í•¨ìˆ˜ê°€ ì—†ì„ë•ŒëŠ” ë³„ë„ì˜ ê·œì¹™ì„ ë”°ë¼, ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ê±°ë‚˜ ëŒ€ê¸°
- ì´ë²¤íŠ¸ ë£¨í”„ê°€ í´ ë‹¨ê³„ ì— ë“¤ì–´ê°€ê³  ì˜ˆì•½ëœ íƒ€ì´ë¨¸ê°€ ì—†ìœ¼ë©´ ë‹¤ìŒ ë‘ ê°€ì§€ ì¤‘ í•˜ë‚˜ê°€ ë°œìƒ
  - 1.` í´ í ê°€ ë¹„ì–´ ìˆì§€ ì•Šìœ¼ë©´` ì´ë²¤íŠ¸ë£¨í”„ê°€ íë¥¼ ìˆœíšŒí•˜ë©° ì²˜ë¦¬
  - 2. `í´ í ê°€ ë¹„ì–´ ìˆìœ¼ë©´` setImmediate()ê°€ ìˆìœ¼ë©´ checkë¡œ ë„˜ì–´ê°. ì—†ìœ¼ë©´ ì´ë²¤íŠ¸ë£¨í”„ê°€ phaseë¥¼ ëŒë©° ì½œë°±ì„ ë¬´í•œíˆ ê¸°ë‹¤ë¦¼

### `check`

- setImmediate()ì—¬ê¸°ì—ì„œ ì½œë°±ì´ í˜¸ì¶œ

### `close callbacks`

- ì¼ë¶€ ë‹«ê¸° ì½œë°±

## ì˜ˆì‹œ

```js
fs.readFile(__filename, () => {
  setTimeout(() => {
    console.log("A");
  }, 0);
  setImmediate(() => {
    console.log("B");
  });
});
```

- fs.readFile ë¼ëŠ” ë¸”ë¡œí‚¹ì‘ì—…ì„ ë§Œë‚œ ì‹œì ì— ì´ë²¤íŠ¸ë£¨í”„ëŠ” ì›Œì»¤ì“°ë ˆë“œì—ê²Œ ì‘ì—…ì„ ë„˜ê¹€
- ì›Œí¬ì“°ë ˆë“œê°€ ì‘ì—…ì„ ì™„ë£Œí•œ ë’¤ I/O callbacks ì˜ì—­ì˜ íì— ì½œë°±ì„ ë“±ë¡
- ì´ë²¤íŠ¸ë£¨í”„ê°€ I/O callbacks ì˜ì—­ì„ ì‹¤í–‰í•  ë•Œ, ì½œë°±ì„ poll ì˜ì—­ì˜ íì— ë“±ë¡
- ì´ë²¤íŠ¸ë£¨í”„ê°€ poll ì˜ì—­ì„ ì‹¤í–‰í•  ë•Œ, íì— 1ê°œê°€ ìˆìœ¼ë¯€ë¡œ ì´ê±¸ ì‹¤í–‰í•¨.
- (ì½œë°±ë‚´ë¶€) 2ë¼ì¸ì—ì„œ setTimeout() ì´ë¯€ë¡œ ë‹¤ì‹œ timers ì˜ì—­ì— ë„£ê³  5ë¼ì¸ìœ¼ë¡œ ê°„ë‹¤.
- (ì½œë°±ë‚´ë¶€) 5ë¼ì¸ì—ì„œ setImmediate() ì´ë¯€ë¡œ check ì˜ì—­ì— ë„£ëŠ”ë‹¤.
- ì´ë²¤íŠ¸ë£¨í”„ê°€ poll íë¥¼ ë¹„ìš°ê³ , ë‹¤ìŒ ì‹¤í–‰ì˜ì—­ì¸ check ì˜ì—­ìœ¼ë¡œ ê°„ë‹¤. check ì˜ì—­ì˜ íì—ëŠ” ë“¤ì–´ìˆëŠ” 'B'ë¥¼ ì½˜ì†”ì— ì°ëŠ”ë‹¤. check ì˜ì—­ì˜ íë¥¼ ë¹„ìš°ê³  ë‹¤ì‹œ whileë¬¸ì˜ ì‹œì‘ì§€ì ìœ¼ë¡œ ê°„ë‹¤.
- ì´ë²¤íŠ¸ë£¨í”„ê°€ timers ì˜ì—­ì„ í˜¸ì¶œí•œë‹¤. uv\_\_run_timers()ëŠ” setTimeout()ì˜ ì½œë°±ì„ pollíì— ë“±ë¡í•œë‹¤.
- ì´ë²¤íŠ¸ë£¨í”„ê°€ 2ë²ˆì§¸ë¡œ poll ì˜ì—­ì„ ì‹¤í–‰í•œë‹¤. íì— 1ê°œê°€ ìˆìœ¼ë¯€ë¡œ ì´ê±¸ ì‹¤í–‰í•˜ê³  'A'ë¥¼ ì°ëŠ”ë‹¤.
- node í”„ë¡œì„¸ìŠ¤ê°€ ë°˜í™˜ë˜ê³  ë

ğŸ‘€ ì°¸ê³ ìë£Œ

- [ì¶”ê°€ì´í•´í•„ìš”](https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/)
- [ì¶”ê°€ì´í•´í•„ìš”](https://nodejs.org/ko/docs/guides/timers-in-node/)
- https://sjh836.tistory.com/149
- https://velog.io/@julianneyi/Node.js-%EB%8F%99%EC%9E%91%EC%9B%90%EB%A6%AC
- https://medium.com/@vdongbin/node-js-%EB%8F%99%EC%9E%91%EC%9B%90%EB%A6%AC-single-thread-event-driven-non-blocking-i-o-event-loop-ce97e58a8e21

# nodejsì˜ ë¹„ë™ê¸° ì²˜ë¦¬

node.jsëŠ” `ë¹„ë™ê¸° I/O`ë¥¼ ì§€ì›í•˜ë©° `single-thread` ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ì„œë²„ë‹¤. nodeì„œë²„ëŠ” ë¹„ë™ê¸° ë°©ì‹ìœ¼ë¡œ ìš”ì²­ì„ ì²˜ë¦¬í•˜ë¯€ë¡œ ìš”ì²­ì„ ì²˜ë¦¬í•˜ë©´ì„œ ë‹¤ìŒ ìš”ì²­ì„ ë°›ì„ ìˆ˜ ìˆë‹¤. ë˜í•œ ë³‘ë ¬ì²˜ë¦¬ë¥¼ threadë¡œ ì²˜ë¦¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ multi-threadê°€ ê°–ëŠ” ë¬¸ì œ(í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ë§ˆë‹¤ Threadë¥¼ ë°œìƒ, ê³µìœ ìì›ì— ëŒ€í•œ ë™ê¸°í™”)ì—ì„œ ììœ ë¡­ë‹¤.

![image](https://user-images.githubusercontent.com/71386219/151757073-91a2b6cf-0e0a-4361-a47c-e0cb93fb40c0.png)

node.jsì˜ `ë¹„ë™ê¸° ì²˜ë¦¬`ëŠ” `ì´ë²¤íŠ¸ ë°©ì‹`ìœ¼ë¡œ ì²˜ë¦¬ëœë‹¤. ì„œë²„ëŠ” `ì´ë²¤íŠ¸ë¥¼ Event Loopë¡œ ë„˜ê²¨ì„œ ì²˜ë¦¬`í•œë‹¤. Event Loopê°€ ì²˜ë¦¬í•˜ëŠ” ë™ì•ˆ ì œì–´ê¶Œì€ ë‹¤ìŒ ìš”ì²­ìœ¼ë¡œ ë„˜ì–´ê°€ê³  ì²˜ë¦¬ê°€ ì™„ë£Œë˜ë©´ `callback`ì„ í˜¸ì¶œí•˜ì—¬ ì²˜ë¦¬ì™„ë£Œë¥¼ í˜¸ì¶œì¸¡ì— ì•Œë ¤ì¤€ë‹¤. ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” Event LoopëŠ” `Single-thread`ë¡œ ì´ë¤„ì¡Œë‹¤. ê·¸ë˜ì„œ ì´ë²¤íŠ¸ í˜¸ì¶œ ì¸¡ì—ëŠ” ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬ë˜ì§€ë§Œ ì²˜ë¦¬ì‘ì—… ìì²´ê°€ ì˜¤ë˜ ê±¸ë¦°ë‹¤ë©´ ì„œë²„ ì „ì²´ ì²˜ë¦¬ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆë‹¤.

## nodejsì˜ ì˜¬ë°”ë¥¸ ì‚¬ìš©

ë”°ë¼ì„œ, ì²˜ë¦¬ ì‘ì—…ì´ cpuë¥¼ ë§ì´ ì†Œëª¨í•˜ê±°ë‚˜, ëŒ€ìš©ëŸ‰ íŒŒì¼ì„ ì²˜ë¦¬í•œë‹¤ë©´ Node.jsì—ì„œëŠ” í° ì•½ì ì´ë‹¤. ê·¸ëŸ¬ë‚˜ `IOì‘ì—…ì´ ë³„ë¡œ ì—†ëŠ” ì–´í”Œë¦¬ìºì´ì…˜`ì´ë‚˜ `ë‹¨ìœ„ ì‘ì—…ì´ ì§§ì€ ë©”ì‹œì§• ì–´í”Œë¦¬ìºì´ì…˜`ì˜ ê²½ìš° ê³ ì„±ëŠ¥ì„ ë³´ì¥í•œë‹¤.

### âœ… NodeëŠ” ë™ê¸°ë³´ë‹¤ ë¹„ë™ê¸° ë°©ì‹ì— ìµìˆ™í•´ì ¸ì•¼ í•œë‹¤.

## ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë° ê¸°ë³¸

1. ë¹„ë™ê¸° API ì‚¬ìš©

- ë¹„ë™ê¸° ì´ë²¤íŠ¸ ë°œìƒì‹œí‚¤ê³  ì™„ë£Œ ì—¬ë¶€ë¥¼ ì•Œ ìˆ˜ ìˆëŠ” callback ì •ì˜

2. ë™ê¸° -> ë¹„ë™ê¸° ì „í™˜

```js
// ë™ê¸°
const fs = require("fs");

let filenames = fs.readdirSync(".");
for (let i = 0; i < filenames.length; i++) {
  console.log(filenames[i]);
}
console.log("ready");
console.log("cna prorcess next job...");
// ì¶œë ¥ê²°ê³¼
// forë¬¸ì˜ console.log
// ready
// cna prorcess next job...

// ë¹„ë™ê¸°
const fs = require("fs");

fs.readdir(".", function (err, filenames) {
  for (let i = 0; i < filenames.length; i++) {
    console.log(filenames[i]);
  }
  console.log("ready");
});
// ì¶œë ¥ê²°ê³¼
// cna prorcess next job...
// forë¬¸ì˜ console.log
// ready
```

3. ë¹„ë™ê¸° í”„ë¡œê·¸ë¨ì—ì„œ ìˆœì°¨ì²˜ë¦¬

- ì¤‘ì²©ëœ callbackì„ í™œìš©í•˜ì—¬ ìˆœì„œê°€ ë³´ì¥ë˜ê²Œ ë§Œë“¤ê¸°
- í•˜ì§€ë§Œ ê³¼ë„í•˜ê²Œ ì‚¬ìš©í•˜ë©´ ì½”ë“œì˜ ê°€ë…ì„±ì´ ë–¨ì–´ì§€ë¯€ë¡œ `async` ëª¨ë“ˆ ì‚¬ìš©

## Node.jsì˜ ë³‘ë ¬ì²˜ë¦¬

- ë¹„ë™ê¸° ë°©ì‹ì´ë¼ë„ Evnet Loopì—ì„œ ì²˜ë¦¬ë˜ëŠ” ì‘ì—…ì´ ê¸´ ì‹œê°„ì„ ìš”êµ¬í•  ë•ŒëŠ” ì„±ëŠ¥ì´ ì €í•˜ë¨. -> `ì´ë²¤íŠ¸ë¥¼ ì˜ê²Œ ìª¼ê°œì–´ ë³‘ë ¬ ì²˜ë¦¬`
- ì¤‘ì²©ëœ Callback í•¨ìˆ˜ë¥¼ `Closure`ë¡œ ì‚¬ìš©í•˜ì—¬ ìì‹ ì˜ Scope ë¿ë§Œ ì•„ë‹ˆë¼ ì™¸ë¶€ í•¨ìˆ˜ì˜ Scopeë¥¼ ê°€ì§€ê²Œí•¨ -> ì˜ˆë¥¼ ë“¤ì–´, `count`ë³€ìˆ˜ë¥¼ ë‘ì–´ í•˜ë‚˜ì˜ ì‘ì—…ì„ ë³‘ë ¬ì²˜ë¦¬í•˜ì—¬ ì–¸ì œ ì „ì²´ ì‘ì—…ì´ ì™„ë£Œë˜ëŠ”ì§€ ì•Œ ìˆ˜ ì—†ì„ ë•Œ, `callbackì´ ì „ë‹¬ëœ íšŸìˆ˜ë§Œí¼ countì— ì €ì¥`í•˜ê³  `ì‘ì—… ì™„ë£Œë  ë•Œë§ˆë‹¤ countë¥¼ í•˜ë‚˜ì”© ê°ì†Œ`. countê°€ 0ì´ë˜ë©´ ëª¨ë“  ì‘ì—… ì™„ë£Œë˜ì—ˆë‹¤ëŠ” ì˜ë¯¸.

## Callbackì˜ í˜¸ì¶œì‹œì 

`Callbackì˜ ì‹œì ì„ ë‹¤ë¥¸ ì½”ë“œì™€ ê°™ì´ ìˆœì°¨ì ìœ¼ë¡œ ìƒê°í•˜ë©´ ì•ˆ ë¨`. -> ë™ê¸°ì ìœ¼ë¡œ ìƒê°í•˜ë©´ ì•ˆëœë‹¤ëŠ” ëœ»â—

ì•„ë˜ ê·¸ë¦¼ì„ ì˜ˆë¡œ ë“¤ë©´, ì½”ë“œìƒì˜ Callbackë¡œì§ì€ ê°€ìš´ë° ìœ„ì¹˜í•˜ì§€ë§Œ Runtimeì— ë“¤ì–´ê°€ë©´ ì™¸ë¶€ ë¡œì§ê³¼ Callbackì€ Event Loopì— ì˜í•´ ì²˜ë¦¬ë˜ì–´ ì–´ëŠ ê²ƒì´ ë¨¼ì € ì‹¤í–‰ë ì§€ ì•Œ ìˆ˜ ì—†ë‹¤.

![image](https://user-images.githubusercontent.com/71386219/151282370-4456d82d-8860-466d-bfdd-346280fbbf03.png)

## êµ¬ì²´ì ì¸ ê³¼ì •

1. ì½”ë“œê°€ í˜¸ì¶œ ìŠ¤íƒì— ìŒ“ì¸ í›„ ì‹¤í–‰í•˜ë˜ ê·¸ê²ƒì´ ë¹„ë™ê¸° ì‘ì—…ì´ë¼ë©´ ì´ë²¤íŠ¸ ë£¨í”„ëŠ” ë¹„ë™ê¸° ì‘ì—…ì„ ìœ„ì„í•©ë‹ˆë‹¤.
2. Nodeë¥¼ êµ¬ì„±í•˜ëŠ” libuvëŠ” í•´ë‹¹ ë¹„ë™ê¸° ì‘ì—…ì´ OSì»¤ë„ì—ì„œ í•  ìˆ˜ ìˆëŠ” ê²ƒì¸ì§€, ì•„ë‹Œì§€(thead poolì—ì„œ ì²˜ë¦¬)ë¥¼ íŒë‹¨í•˜ì—¬ ë¹„ë™ê¸° í•¨ìˆ˜ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
3. ë¹„ë™ê¸° ì‘ì—…ì„ ì²˜ë¦¬í•˜ê³  ì½œë°± í•¨ìˆ˜ë¥¼ ì´ë²¤íŠ¸ ë£¨í”„ë¥¼ í†µí•´ íƒœìŠ¤í¬ íì— ë„˜ê²¨ì£¼ê²Œ ë©ë‹ˆë‹¤.
4. ì´ë²¤íŠ¸ ë£¨í”„ëŠ” ì½œìŠ¤íƒì— ìŒ“ì—¬ìˆëŠ” í•¨ìˆ˜ê°€ ì—†ì„ ë•Œì—, íƒœìŠ¤í¬ íì—ì„œ ëŒ€ê¸°í•˜ê³  ìˆë˜ ì½œë°±í•¨ìˆ˜ë¥¼ ì½œìŠ¤íƒìœ¼ë¡œ ë„˜ê²¨ì¤ë‹ˆë‹¤
5. ì½œìŠ¤íƒì— ìŒ“ì¸ ì½œë°±í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ê³ , ì½œìŠ¤íƒì—ì„œ ì œê±°ë©ë‹ˆë‹¤.

ğŸ” ì°¸ê³ ìë£Œ

- https://www.nextree.co.kr/p7292/
- https://nodejs.org/ko/docs/guides/timers-in-node/
- https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/
- https://darrengwon.tistory.com/953

# event emitter

NodeëŠ” ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ì„œ EventEmitter ë¼ëŠ” í´ë˜ìŠ¤ë¥¼ ì œê³µ

ì´ë²¤íŠ¸ê°€ ì¼ì–´ë‚˜ë©´ ì´ë²¤íŠ¸ë¥¼ ë‹´ë‹¹í•˜ëŠ” `ì´ë²¤íŠ¸ ê°ì²´(event emitter)`ì—ì„œ ì´ë²¤íŠ¸ê°€ ì¼ì–´ë‚¬ìŒì„ ì•Œë¦¼. ê·¸ í›„ ì •í•´ë‘” ë¡œì§ì„ ì‹¤í–‰.

EventEmitterì˜ emití•¨ìˆ˜ê°€ í˜¸ì¶œë˜ë©´, emitterëŠ” ë™ê¸°ì ìœ¼ë¡œ ë“±ë¡ë˜ì–´ ìˆëŠ” ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜ë¥¼ `ìˆœì°¨ì ìœ¼ë¡œ í˜¸ì¶œ`í•œë‹¤.

ë•Œë¬¸ì—, ì¼ë°˜ì ìœ¼ë¡œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ ì›ë˜ ë“±ë¡ëœ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë³´ë‹¤ ë‚˜ì¤‘ì— í˜¸ì¶œë˜ê¸° ë•Œë¬¸ì— ë¹„ë™ê¸°ì²˜ëŸ¼ ë³´ì¸ë‹¤. í•˜ì§€ë§Œ` EventEmitterì˜ ì¸ìŠ¤í„´ìŠ¤ëŠ” EventEmitter ì¸ìŠ¤í„´ìŠ¤ ìì²´ë‚´ì—ì„œ ì´ë²¤íŠ¸ì™€ ì—°ê²¬ë  ëª¨ë“  ì´ë²¤íŠ¸ì™€ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ì `í•œë‹¤. ë”°ë¼ì„œ `EventLoopì˜ íë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë‹¤.` ê°ì²´ê°€ ì´ë²¤íŠ¸ë¥¼ ë°œìƒ ì‹œí‚¤ë©´ í•´ë‹¹ EventEmitterì´ë²¤íŠ¸ì— ì—°ê²°ëœ ëª¨ë“  í•¨ìˆ˜ê°€ ë™ê¸°ì  ìœ¼ë¡œ í˜¸ì¶œëœë‹¤.. í˜¸ì¶œëœ ë¦¬ìŠ¤ë„ˆì—ì„œ ë°˜í™˜ëœ ëª¨ë“  ê°’ì€ ë¬´ì‹œ ë˜ê³  ë²„ë ¤ì§„ë‹¤.

### ë¹„ë™ê¸°ì‹ ëŒ€ ë™ê¸°ì‹

ëª¨ë“  ë¦¬ìŠ¤ë„ˆëŠ” ë“±ë¡ ëœ EventEmitterìˆœì„œëŒ€ë¡œ ë™ê¸°ì ìœ¼ë¡œ í˜¸ì¶œí•©ë‹ˆë‹¤. ì´ëŠ” ì´ë²¤íŠ¸ì˜ ì ì ˆí•œ ìˆœì„œë¥¼ ë³´ì¥í•˜ê³  ê²½ìŸ ì¡°ê±´ ë° ë…¼ë¦¬ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤. setImmediate()ì ì ˆí•œ ê²½ìš° ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜ëŠ” ë˜ëŠ” process.nextTick()ë©”ì„œë“œ ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹„ë™ê¸° ì‘ì—… ëª¨ë“œë¡œ ì „í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```js
const myEmitter = new MyEmitter();
myEmitter.on("event", (a, b) => {
  setImmediate(() => {
    console.log("this happens asynchronously");
  });
});
myEmitter.emit("event", "a", "b");
```

### ëŒ€í‘œì ì¸ ë©”ì†Œë“œ

eventEmitter.on()

- ì´ë²¤íŠ¸ì˜ íƒ€ì…ê³¼ ë¦¬ìŠ¤ë„ˆë¥¼ ì¸ìë¡œ ë°›ì•„ Emitter ê°ì²´ì— ì¶”ê°€í•˜ëŠ” ì—­í• 
- `íŠ¹ì • ìƒí™©ì— ì‹¤í–‰ì‹œí‚¬ ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜ë¥¼ Emitter ì•ˆì— ë“±ë¡í•œë‹¤ëŠ” ì˜ë¯¸`

eventEmitter.emit()

- ë“±ë¡í•œ ì´ë²¤íŠ¸ë¥¼ í˜¸ì¶œ

eventEmitter.once()

- íŠ¹ì • ì´ë²¤íŠ¸ì— ëŒ€í•´ ìµœëŒ€ í•œ ë²ˆë§Œ í˜¸ì¶œë˜ëŠ” ë¦¬ìŠ¤ë„ˆë¥¼ ë“±ë¡

eventEmitter.on("error", cb) & events.errorMonitor

- ì¸ìŠ¤í„´ìŠ¤ ë‚´ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒ EventEmitterí•˜ë©´ ì¼ë°˜ì ì¸ ì‘ì—…ì€ 'error'ì´ë²¤íŠ¸ë¥¼ ë‚´ë³´ë‚´ëŠ” ê²ƒ. ì´ë“¤ì€ Node.js ë‚´ì—ì„œ íŠ¹ë³„í•œ ê²½ìš°ë¡œ ì·¨ê¸‰.
- 'error'ê°€ì¥ ì¢‹ì€ ë°©ë²•ì€ ì´ë²¤íŠ¸ ì— ëŒ€í•œ ë¦¬ìŠ¤ë„ˆë¥¼ í•­ìƒ ì¶”ê°€í•˜ëŠ” ê²ƒ.
- 'error'ê¸°í˜¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì¹˜í•˜ë©´ ë°œìƒí•œ ì˜¤ë¥˜ë¥¼ ì†Œëª¨í•˜ì§€ ì•Šê³  ì´ë²¤íŠ¸ ë¥¼ ëª¨ë‹ˆí„°ë§

```js
const { EventEmitter, errorMonitor } = require("events");

const myEmitter = new EventEmitter();
myEmitter.on(errorMonitor, (err) => {
  MyMonitoringTool.log(err);
});
myEmitter.emit("error", new Error("whoops!"));
// Still throws and crashes Node.js
```

í´ë˜ìŠ¤: EventEmitter

- ëª¨ë“  EventEmittersëŠ” ìƒˆë¡œìš´ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•  ë•Œë§ˆë‹¤ 'newListner' ì´ë²¤íŠ¸ë¥¼ í˜¸ì¶œí•˜ê³  ë¦¬ìŠ¤ë„ˆë¥¼ ì œê±°í•  ë•Œë§ˆë‹¤ 'removeListner'ë¥¼ í˜¸ì¶œ

ğŸ” ì°¸ê³ ìë£Œ

- https://nodejs.org/docs/latest-v15.x/api/events.html#events_events
- https://on-ad.github.io/node.js/2019/04/09/Nodejs-EventEmitter.html
- https://www.huskyhoochu.com/nodejs-eventemitter/
- https://edykim.com/ko/post/events-eventemitter-translation-in-node.js/
