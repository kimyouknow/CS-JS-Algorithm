# 트랜잭션,커밋,롤백,전파,Lock

## 트랜잭션

데이터베이스에서 하나의 논리적 기능을 수행하기 위한 작업의 단위입니다.

데이터베이스 내에서 수행되는 작업의 최소 단위로, 데이터베이스의 무결성을 유지하며 DB의 상태를 변화시키는 기능을 수행합니다. 트랜잭션은 하나 이상의 query를 포함해야 하고, ACID라고 칭해지는 원자성, 일관성, 고립성, 지속성의 4가지 규칙을 만족해야합니다.

- Atomicity(원자성) : 트랜잭션은에 포함된 작업은 전부 수행되거나 아니면 전부 수행되지 말아야 합니다.(all or nothing)
- Consistency(일관성): 트랜잭션은이 실행을 성공적으로 완료하면 언제나 일관성 있는 데이터베이스 상태로 유지하는 것을 의미합니다. 송금 전후 모두 잔액의 data type은 integer이여야 한다는 것이 일관성의 한 예가 될 수 있습니다.
- Isolation(고립성): 여러 트랜잭션은 동시에 수행됩니다. 이때 각 트랜잭션은 다른 트랜잭션은의 연산 작업이 끼어들지 못하도록 보장하여 독립적으로 작업을 수행합니다. 따라서 동시에 수행되는 트랜잭션은이 동일한 data를 가지고 충돌하지 않도록 제어해줘야 합니다. 이를 동시성제어(concurrency control) 라고합니다.
- Durability(지속성): 성공적으로 수행된 트랜잭션은 데이터베이스에 영원히 반영되어야 함을 의미합니다. 트랜잭션은이 완료되어 저장이 된 데이터베이스는 저장 후에 생기는 정전, 장애, 오류 등에 영향을 받지 않아야 합니다.

### 트랜잭선의 격리성과 동시성

트랜잭션의 격리성(Isolation)은 여러 트랜잭션이 동시에 실행될 때, 서로 간섭하지 않고 독립적으로 실행되는 것을 보장하는 것을 말합니다. 이를 통해 트랜잭션 실행 중 다른 트랜잭션이나 외부 요인으로 인해 데이터 불일치 문제를 예방할 수 있습니다.

격리성과 동시성은 반비례합니다. 격리성이 너무 높으면 동시성은 떨어지고 격리성이 너무 낮으면 동시성은 높아집니다.

동시성(Concurrency)은 여러 트랜잭션이 동시에 실행될 수 있는 환경을 제공하는 것을 말합니다. 데이터베이스 시스템에서는 동시성 제어를 통해 여러 사용자가 동시에 데이터를 접근하고 수정할 수 있도록 해주면서도 데이터 일관성과 무결성을 보장합니다.

트랜잭션의 격리성과 동시성은 상호 연관된 개념으로, 여러 트랜잭션이 동시에 실행될 때 데이터 일관성과 무결성을 유지하기 위해 트랜잭션 간의 격리성이 보장되어야 합니다. 대표적인 격리 수준(Isolation Level)으로는 READ UNCOMMITTED, READ COMMITTED, REPEATABLE READ, SERIALIZABLE 등이 있으며, 각각 다른 수준의 격리성과 동시성을 제공합니다.

### 동시성 제어

동시성 제어(Concurrency Control)는 여러 사용자가 동시에 데이터베이스를 접근하여 데이터를 수정, 삭제, 삽입하는 경우 발생하는 데이터 일관성 문제를 해결하기 위한 기술입니다. 동시성 제어를 하지 않으면 여러 사용자가 동시에 같은 데이터를 수정하려고 할 때 일어나는 갱신 손실(Update Anomaly) 문제가 발생합니다.

### 갱신손실

갱신손실이란 여러 개의 트랜잭션이 한 개의 데이터를 동시에 갱신(update)할 때 어느 한 트랜잭션의 갱신이 무효화 될 수 있는 상황입니다.

> 예: 한 사용자가 계좌의 잔액을 1000원에서 500원으로 수정하고, 다른 사용자가 동시에 같은 계좌의 잔액을 1000원에서 1500원으로 수정하는 경우, 데이터베이스는 어떤 값을 가지고 있어야 할까요?

각각의 사용자가 수정한 값을 모두 반영할 수는 없기 때문에 데이터 일관성을 유지하기 위해 하나의 값을 선택하고 나머지 값을 무시해야 합니다. 이렇게 되면 데이터의 일관성이 깨지게 되므로, 이러한 문제를 해결하기 위해 동시성 제어가 필요합니다.

### Lock

갱신손실 문제를 해결하기 위한 방법중에 하나로 데이터를 수정중에 있는 트랜잭션은 해당 데이터를 Lock으로 잠금장치를 하여 다른 트랜잭션이 접근하지 못하게 하는 방법이 있습니다. Lock이 걸린 데이터는 Unlock이 될 때까지 다른 트랜잭션들은 접근하지 못하고 기다려야 합니다.

Lock은 여러 사용자가 동시에 데이터를 수정하는 것을 방지하기 위해 데이터를 접근하는 권한을 제어하는 것입니다. Lock을 사용하면 동시에 여러 사용자가 같은 데이터에 접근하지 못하도록 하며, 갱신 손실 문제를 해결할 수 있습니다.

## Commit과 Rollback

데이터베이스는 COMMIT과 ROLLBACK 명령어를 통해 `데이터 무결성`을 보장합니다.

### Commit

COMMIT은 트랜잭션이 완료되었음을 알리는 명령어입니다. 트랜잭션이 성공적으로 완료되면 데이터베이스는 해당 트랜잭션을 디스크에 기록합니다. 이 때, 트랜잭션 내에서 수행한 모든 변경 작업이 적용되어 데이터의 일관성이 유지됩니다.

### Rollback

ROLLBACK은 트랜잭션을 취소하고 이전 상태로 되돌리는 명령어입니다. 트랜잭션 중에 문제가 발생하여 롤백을 실행하면 해당 트랜잭션에서 수행한 변경 작업들은 모두 취소되며, 데이터 일관성이 유지됩니다.

## 데드락

데이터베이스에서 Deadlock은 두 개 이상의 트랜잭션이 서로 다른 자원(예: 테이블, 레코드, 로우 락 등)을 요청하고, 서로 상대방이 가지고 있는 자원을 대기하며 무한히 기다리는 상태를 의미합니다.

두 트랜젝션이 각각 lock을 설정하고, unlock을 하지 않은 상태에서 서로의 lock이 걸린 데이터에 접근하려고 할 때, 서로 대기를 계속하여 영원히 처리되지 않는 상황이 발생합니다.

이러한 상태에서는 두 개 이상의 트랜잭션이 모두 처리되지 않아서 시스템이 멈추게 되며, 해당 자원에 대한 동시성 제어 기법(예: 락)을 이용해서 상호배제(Mutual Exclusion)를 해제하지 않으면 해결할 수 없습니다.

### 해결방법

- 1. 예방기법: 각 트랜젝션이 실행되기 전에 필요한 데이터를 모두 Locking 해주는 것입니다. 하지만 locking해줘야 하는 데이터가 많다면 사실상 모든 데이터를 전부 locking한 것과 동일하여 트랜젝션의 병행성을 보장하지 못할 수 있습니다.
- 2. 회피기법: 자원을 할당할 때 timestamp를 사용하여 deadlock가 일어나지 않도록 회피하는 방법입니다.
- 3. 탐지/회복 기법: 트랜젝션이 실행되기 전에는 아무런 검사를 하지 않고, deadlock이 발생하면 이를 감지하고 회복시키는 방법입니다.

## 참고자료

- 면접을 위한 CS 전공지식 노트 - 주홍철
- https://github.com/Seogeurim/CS-study/tree/main/contents/database
- https://github.com/gyoogle/tech-interview-for-developer#database
- https://inpa.tistory.com/entry/DB-📚-데이터-모델링-1N-관계-📈-ERD-다이어그램
- https://www.youtube.com/watch?v=IMDH4iAQ6zM
